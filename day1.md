## Day 1
 - Target Hardware    : stm32mp157d-dk1
 - Target Hardware ip : 192.168.1.106
 - Host Machine       : Ubuntu 20.04
 - Host Machine ip    : 192.168.1.106

## Setup NFS Server

### 1. Setup nfs-server

```sh
sudo apt install nfs-kernel-server
sudo mkdir -m 777 /nfs
```

### 2. edit /etc/exports by addin this line
```sh
/nfs *(rw,sync,no_root_squash,subtree_check)
```

### 3. Update a new configuration
```sh
sudo exportfs -r
```

--- 

## Configure the build, customize the output images and use NFS

### 1. edit bootfs/mmc0_extlinux/stm32mp157d-dk1_extlinux.conf
Remark: Im not sure which is my hardware variance, So I Change them all

```sh
# Generic Distro Configuration file generated by OpenEmbedded
menu title Select the boot mode
MENU BACKGROUND /splash_portrait.bmp
TIMEOUT 20
DEFAULT OpenSTLinux
LABEL OpenSTLinux
	KERNEL /uImage
	FDTDIR /
	APPEND root=/dev/nfs rw console=ttySTM0,115200 nfsroot=192.168.1.106:/nfs,vers=3,tcp ip=192.168.1.10
LABEL stm32mp157d-dk1-a7-examples
	KERNEL /uImage
	FDT /stm32mp157d-dk1-a7-examples.dtb
	APPEND root=/dev/nfs rw console=ttySTM0,115200 nfsroot=192.168.1.106:/nfs,vers=3,tcp ip=192.168.1.10
LABEL stm32mp157d-dk1-m4-examples
	KERNEL /uImage
	FDT /stm32mp157d-dk1-m4-examples.dtb
	APPEND root=/dev/nfs rw console=ttySTM0,115200 nfsroot=192.168.1.106:/nfs,vers=3,tcp ip=192.168.1.10
```

### 2. edit conf/local.conf by adding
```sh
IMAGE_INSTALL:append = " dropbear"
``` 

### 3. start built the image
```sh
bitbake core-image-minimal
```

### 4. Extract a new rootfs into /nfs
```sh
sudo tar xpf tmp/deploy/images/stm32mp1/core-image-minimal-stm32mp1.rootfs.tar.xz -C /nfs/
```

--- 

## Setup TFTP Server

### 1. Install TFTP Package
```sh
sudo apt install tftpd-hpa
```

### 2. The default location is /srv/tftp (From /etc/default/tftpd-hpa)
```sh
cat /etc/default/tftpd-hpa 
```

```sh
# /etc/default/tftpd-hpa

TFTP_USERNAME="tftp"
TFTP_DIRECTORY="/srv/tftp"
TFTP_ADDRESS=":69"
TFTP_OPTIONS="--secure"
```

### 3.1 Testing TFTP Server, Create a simple text file
```sh
# cat /srv/tftp/test 
This file come from tftp server
```

### 3.2 from **u-boot shell**
```sh
STM32MP> setenv ipaddr 192.168.0.100
STM32MP> setenv serverip 192.168.0.1
STM32MP> saveenv
```

### 3.3 You can verify a new value
```sh
STM32MP> printenv serverip            
serverip=192.168.1.106
STM32MP> printenv ipaddr  
ipaddr=192.168.1.10
```

### 3.4 Get file from Host machine (192.168.1.106)
```sh
STM32MP> tftp 0xc2000000 test
Using ethernet@5800a000 device
TFTP from server 192.168.1.106; our IP address is 192.168.1.10
Filename 'test'.
Load address: 0xc2000000
Loading: ##################################################  32 Bytes
	 2.9 KiB/s
done
Bytes transferred = 32 (20 hex)
```

### 3.5 Read at address 0xc2000000
```sh
STM32MP> md 0xc2000000
c2000000: 73696854 6c696620 6f632065 6620656d  This file come f
c2000010: 206d6f72 70746674 72657320 0a726576  rom tftp server.
c2000020: d9af1710 c1806800 00000000 00000000  .....h..........
c2000030: 00000000 00000000 00000000 00000000  ................
c2000040: 00000000 00000000 00000000 00000000  ................
c2000050: 00000000 00000000 00000000 00000000  ................
c2000060: 00000000 00000000 00000000 00000000  ................
c2000070: 00000000 00000000 00000000 00000000  ................
c2000080: 00000000 00000000 00000000 00000000  ................
c2000090: 00000000 00000000 00000000 00000000  ................
c20000a0: 00000000 00000000 00000000 00000000  ................
c20000b0: 00000000 00000000 00000000 00000000  ................
c20000c0: 00000000 00000000 00000000 00000000  ................
c20000d0: 00000000 00000000 00000000 00000000  ................
c20000e0: 00000000 00000000 00000000 00000000  ................
c20000f0: 00000000 00000000 00000000 00000000  ................
```

### 3.6 Edit bootcmd and bootargs
```sh
STM32MP> setenv bootcmd 'tftp 0xc2000000 zImage; tftp 0xc4000000 dtb; bootz 0xc2000000 - 0xc4000000' 
STM32MP> setenv bootargs root=/dev/nfs rw console=ttySTM0,115200 nfsroot=192.168.1.106:/nfs,vers=3,tcp ip=192.168.1.10
STM32MP> saveenv 
Saving Environment to MMC... Writing to MMC(0)... OK
```

### 3.7 Put zImage and stm32mp157d-dk1.dtb to /srv/tftp
```sh
sudo cp tmp/deploy/images/stm32mp1/kernel/zImage /srv/tftp/
sudo cp tmp/deploy/images/stm32mp1/kernel/stm32mp157d-dk1.dtb /srv/tftp/dtb
```

**Remark: From 3.6 - You must rename stm32mp157d-dk1.dtb TO dtb**

### 3.8 From u-boot shell, boot the board
```sh
STM32MP> boot
ethernet@5800a000 Waiting for PHY auto negotiation to complete...... done
Using ethernet@5800a000 device
TFTP from server 192.168.1.106; our IP address is 192.168.1.10
Filename 'zImage'.
Load address: 0xc2000000
Loading: ##################################################  7.5 MiB
	 8.2 MiB/s
done
Bytes transferred = 7829144 (777698 hex)
Using ethernet@5800a000 device
TFTP from server 192.168.1.106; our IP address is 192.168.1.10
Filename 'dtb'.
Load address: 0xc4000000
Loading: ##################################################  122 KiB
	 10.8 MiB/s
done
Bytes transferred = 124979 (1e833 hex)
Kernel image @ 0xc2000000 [ 0x000000 - 0x777698 ]
## Flattened Device Tree blob at c4000000
   Booting using the fdt blob at 0xc4000000
   Loading Device Tree to cffde000, end cffff832 ... OK

Starting kernel ...
```
